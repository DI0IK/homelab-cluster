apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
  namespace: immich
spec:
  releaseName: immich
  chart:
    spec:
      chart: immich
      version: "0.9.3"
      sourceRef:
        kind: HelmRepository
        name: immich
  interval: 50m
  install:
    remediation:
      retries: 3
    crds: Create
  values:
    immich:
      metrics:
        enabled: true
      persistence:
        library:
          existingClaim: immich-pvc
      configuration:
        machineLearning:
          clip:
            enabled: true
            modelName: "ViT-B-16-SigLIP2__webli"
          "facialRecognition":
            {
              "enabled": true,
              "modelName": "buffalo_l",
              "minScore": 0.7,
              "maxDistance": 0.3,
              "minFaces": 3,
            }
        trash:
          enabled: false
          days: 30
        storageTemplate:
          enabled: true
          template: "{{y}}/{{MM}}/{{dd}}/{{filename}}"
        oauth:
          autoLaunch: true
          autoRegister: true
          buttonText: "Login with Authentik"
          clientId: iPFX7ek90F00029l0XIxCiPyxGUZaiqvXu3HaI1k
          clientSecret: 1Qao7wBy04TuUYRs9uiWeV48QMap23MTFqt23gaEvoC5BXw6jrVdReGyXqkobnGlegyF9WclGZLKJaWNv7ywrywjupwdB4aEEUTxkdQYWjyEm633MTyj7s0W5j1LXxRN
          defaultStorageQuota: 0
          enabled: true
          issuerUrl: https://sso.dominikstahl.dev:10443/application/o/immich/
        passwordLogin:
          enabled: false
        server:
          externalDomain: https://photos.dominikstahl.dev
        ffmpeg:
          {
            "crf": 23,
            "threads": 0,
            "preset": "ultrafast",
            "targetVideoCodec": "h264",
            "acceptedVideoCodecs": ["h264"],
            "targetAudioCodec": "aac",
            "acceptedAudioCodecs": ["aac", "mp3", "libopus"],
            "acceptedContainers": ["mov", "ogg", "webm"],
            "targetResolution": "720",
            "maxBitrate": "0",
            "bframes": -1,
            "refs": 0,
            "gopSize": 0,
            "temporalAQ": false,
            "cqMode": "auto",
            "twoPass": false,
            "preferredHwDevice": "auto",
            "transcode": "required",
            "tonemap": "hable",
            "accel": "qsv",
            "accelDecode": true,
          }
        job:
          {
            "backgroundTask": { "concurrency": 5 },
            "smartSearch": { "concurrency": 4 },
            "metadataExtraction": { "concurrency": 5 },
            "faceDetection": { "concurrency": 3 },
            "search": { "concurrency": 5 },
            "sidecar": { "concurrency": 5 },
            "library": { "concurrency": 5 },
            "migration": { "concurrency": 5 },
            "thumbnailGeneration": { "concurrency": 5 },
            "videoConversion": { "concurrency": 1 },
            "notifications": { "concurrency": 5 },
          }
        "library":
          {
            "scan": { "enabled": true, "cronExpression": "0 10 * * *" },
            "watch": { "enabled": false },
          }
    redis:
      enabled: true
    env:
      DB_HOSTNAME: immich-rw
      DB_USERNAME: immich
      DB_DATABASE_NAME: immich
      DB_PASSWORD: immich

    image:
      #repository: "ghcr.io/immich-app/immich-server"
      tag: v2.0.1

    server:
      persistence:
        external:
          enabled: true
          existingClaim: immich-ext-pvc
          mountPath: /usr/src/app/externalLibraries
          readOnly: true
        external-manger:
          enabled: true
          existingClaim: immich-ext-manger-pvc
          mountPath: /usr/src/app/externalLibraries_manger
          readOnly: true
      #        external-wolkestahl:
      #          enabled: true
      #          readOnly: true
      #          type: hostPath
      #          hostPath: /Bilder
      #          hostPathType: Directory
      #          mountPath: /usr/src/app/externalLibraries_wolkestahl
      controller:
        replicas: 1
        strategy: RollingUpdate
    machine-learning:
      enabled: true
      image:
        repository: ghcr.io/immich-app/immich-machine-learning
        tag: v2.0.1
      controller:
        replicas: 1
        strategy: RollingUpdate
